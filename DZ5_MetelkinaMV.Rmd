---
title: "DZ5"
output: html_document
---

## Домашнее задание 5

*Выполнила Метелкина Марина*

**Тема:** построение регрессионных моделей и анализ выживаемости.

**Цель:** научиться пользоваться основными методами регрессионного анализа, разобраться с принципами анализа выживаемости.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# импорт библиотек
library(ggplot2)
library(ggsurvfit)
library(tidyverse)
library(car)
library(survminer)
library(survival)
```

#### Описание ДЗ

Используемый датасет Breast Cancer Wisconsin. В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

```{r}
# Загрузка датасета
data_canc <- read.csv('wisconsin_breast_cancer.csv', sep=",")
```

```{r}
# Изучение данных
head(data_canc)
str(data_canc)
```

### Задание 1.

Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).

Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

```{r}
# Создание модели связи среднего радиуса опухоли и средней площади (а)
model_a <- lm(radius_mean ~ area_mean, data = data_canc)
summary(model_a)
```

```{r}
# Построение графика модели
ggplot(data_canc, aes(x = area_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

```

**Вывод:** Между средним радиусом опухоли и средней площадью наблюдается положительная взимосвязь (есть тенденция к положению на одной прямой).

```{r}
# Создание модели связи среднего радиуса опухоли и среднего периметра (б)
model_b <- lm(radius_mean ~ perimeter_mean, data = data_canc)
```

```{r}
# Построение графикa модели
ggplot(data_canc, aes(x = perimeter_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

```

**Вывод:** Наблюдается положительная взаимосвязь между средним радиусом и средним периметром (данные лежат преимущественно на одной прямой).

```{r}
# Создание модель взаимосвязи среднего радиуса опухоли и средней симметричности (в)
model_v <- lm(radius_mean ~ symmetry_mean, data = data_canc)
```

```{r}
# Построение графика модели
ggplot(data_canc, aes(x = symmetry_mean, y = radius_mean)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

```

**Вывод:** Ваимосвязь между средним радиусом опухоли и средней симметричность слабая или отсутвует вовсе (данные не лежат на одной прямой ни в каком отрезке).

### Задание 2.

Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0.

Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

```{r}
# Преобразование диагнозов (замена М - злокачественная опухоль и B - доброкачественная на 1 и 0 )
data_canc$diagnosis <- ifelse(data_canc$diagnosis == 'M', 1, 0)

# Проверка
head(select(data_canc, diagnosis), 10)
```

Зададим уровень значимости alpha = 0.05.

```{r}
# Создание модели логистической регрессии
model_regres <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data_canc, family = "binomial")
summary(model_regres)
```

Значение p-value для среднего радиуса и средней площади статистически не значимое, так как p-value \> alpha, то есть связь данных признакрв статистически не значима и не влияет на вероятность диагностирования злокачественной опухоли. Для текстуры опухоли p-value \< alpha, следовательно этот признак статистически значимо отражает взаимосвязь фактора и типа опухоли.

Для большей информативности необходимо преобразование коэффициентов модели.

```{r}
exp(coefficients(model_regres))
```

**Вывод:** При диагностировании доброкачественной опухоли в отличие от злокачественной признак средней текстуры опухоли будет в 1.23 раз больше (разница достоверная). Зависимость других факторов (среднего радиуса и средней площади) и типа опухоли статистически незначимо.

Логистическая регрессионная модель отражает прогноз вероятности возникновения злокачественной опухоли от всех трех перечисленных факторов при их взаимодействии.

```{r}
# Визуализация кривой логистической регрессии зависимости типа опухоли и среднего радиуса опухоли
data_canc %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
# Визуализация кривой логистической регрессии зависимости типа опухоли и средней площади опухоли 
data_canc %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
# Визуализация кривой логистической регрессии зависимости типа опухоли и среднего значения текстуры опухоли
data_canc %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
model_regres_2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = data_canc,
      family = "binomial")

summary(model_regres_2)
```

**Вывод:** По результатам логистической регрессии с взаимодействием всех 3 факторов p-value \> alpha, соответвенно все взаимодействия статистически не значимы.

### Задание 3.

Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

**Датасет содержит следующий набор переменных:**

-   inst: код учреждения;

-   time: время выживаемости в днях;

-   status: 1 = цензурирование, 2 = смерть;

-   age: возраст в годах; sex: мужской = 1, женский = 2;

-   ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;

-   ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;

-   pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;

-   meal.cal: калории потребляемой пищи; wt.loss: потеря веса за последние полгода.

Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.

Изучите работу функций Surv(), survfit() и ggsurvplot():

Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним).

Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.

Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.

С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость.

```{r}
# Загрузка данных
lung = survival::lung

# Создание переменной event
lung$event <- as.numeric(lung$status == 2)
```

```{r}
# Создание модели выживаемости для каждого пола 
lung_survfit <- survfit(Surv(time, status) ~ sex, data = lung)

# Отображение модели на графике (sex=1 мужчины, sex=2 женщины)
ggsurvplot(lung_survfit, data = lung, risk.table = TRUE) 
```

```{r}
# Выполнение log-rank теста для сравнения выживаемости мужчин и женщин
lung_surv <- survdiff(Surv(time, status) ~ sex, data = lung)
lung_surv
```

**Вывод:** Выживаемость у женщин (sex = 2) выше, чем у мужчин. Такая взаимосвязт наблюдается и по графику. По log-rank тесту: p-value = 0.001 \< 0.05 (между группами есть статистически значимая разница).

```{r}
# Построение графика кумулятивной функции рисков (cumulative hazard function) для пола
ggsurvplot(lung_survfit, data = lung, fun = "cumhaz", conf.int = TRUE)
```

**Вывод:** По графику видно, что кумулятивный риск (наступления исхода) выше у мужчин (sex = 1), чем у женщин и с течением времени данный риск возрастает. Однако, наблюдается снижение числа наблюдений с течением времени, что может влиять на точность результатов.

```{r}
# Создание Cox-регрессию
lung_cox <- coxph(Surv(time, status) ~ sex, data = lung)
summary(lung_cox)
```

```{r}
# Построение график
ggsurvplot(surv_fit(lung_cox, data = lung), data = lung)
```

**Вывод:** Пол является статистически значимым предиктором, так как значение p-value \< 0.05). Коэффицент (coef) равен -0.53, значит риск для женщин меньше, чем для мужчин. exp(coef) = 0.5880, значит, что для женщин hazard меньше на 0.588 (риск меньше на 41%)
